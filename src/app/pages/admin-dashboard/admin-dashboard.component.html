<div class="container-fluid min-vh-100 bg-light">
  <!-- Header -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-shield-check-fill me-2"></i>
        Admin Dashboard
      </a>
      <div class="navbar-nav ms-auto">
        <button class="btn btn-outline-light btn-sm" (click)="logout()">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Statistics Row -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center border-primary">
          <div class="card-body">
            <i class="bi bi-people-fill display-4 text-primary"></i>
            <h3 class="mt-2">{{ getTotalViewers() }}</h3>
            <p class="text-muted mb-0">Total Viewers</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center border-danger">
          <div class="card-body">
            <i class="bi bi-heart-fill display-4 text-danger"></i>
            <h3 class="mt-2">{{ getTotalLikes() }}</h3>
            <p class="text-muted mb-0">Total Likes</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center border-success">
          <div class="card-body">
            <i class="bi bi-megaphone-fill display-4 text-success"></i>
            <h3 class="mt-2">{{ getTotalAnnouncements() }}</h3>
            <p class="text-muted mb-0">Total Announcements</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center border-warning">
          <div class="card-body">
            <i class="bi bi-download display-4 text-warning"></i>
            <h3 class="mt-2">{{ getTotalDownloads() }}</h3>
            <p class="text-muted mb-0">Total Downloads</p>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Announcement Form -->
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-pencil-square me-2"></i>
              {{ isEditMode() ? 'Update' : 'Create New' }} Announcement
            </h5>
            <div class="btn-group">
              <button 
                *ngIf="isEditMode()" 
                class="btn btn-outline-secondary btn-sm"
                (click)="cancelEdit()"
                type="button"
              >
                <i class="bi bi-x-circle"></i>
                Cancel Edit
              </button>
              <button 
                *ngIf="hasAnnouncement()" 
                class="btn btn-outline-danger btn-sm"
                (click)="showDeleteConfirmation()"
                [disabled]="isDeleting()"
                type="button"
              >
                <i class="bi bi-trash3"></i>
                {{ isDeleting() ? 'Deleting...' : 'Delete Current' }}
              </button>
            </div>
          </div>
          <div class="card-body">
            <div *ngIf="successMessage()" class="alert alert-success alert-dismissible">
              <i class="bi bi-check-circle-fill me-2"></i>
              {{ successMessage() }}
            </div>

            <form (ngSubmit)="onSubmit()" #announcementForm="ngForm">
              <div class="mb-3">
                <label for="title" class="form-label">Announcement Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="title"
                  [value]="title()"
                  (input)="updateTitle($any($event.target).value)"
                  placeholder="Enter announcement title"
                  required
                >
              </div>

              <div class="mb-4">
                <label for="content" class="form-label">Announcement Content</label>
                <textarea
                  class="form-control"
                  id="content"
                  rows="6"
                  [value]="content()"
                  (input)="updateContent($any($event.target).value)"
                  placeholder="Enter announcement content..."
                  required
                ></textarea>
              </div>

              <!-- File Upload Section -->
              <div class="mb-4">
                <label class="form-label">File Attachments</label>
                
                <!-- File Input -->
                <div class="mb-3">
                  <input
                    type="file"
                    class="form-control"
                    id="fileInput"
                    multiple
                    accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.txt,.zip,.rar"
                    (change)="onFileSelected($event)"
                  >
                  <div class="form-text">
                    <i class="bi bi-info-circle me-1"></i>
                    Supported: PDF, Word, Excel, PowerPoint, Images, Text, Archives (Max 10MB each)
                  </div>
                </div>

                <!-- Selected Files Preview -->
                <div *ngIf="selectedFiles().length > 0" class="mb-3">
                  <h6 class="text-muted">Selected Files:</h6>
                  <div class="list-group list-group-flush">
                    <div 
                      *ngFor="let file of selectedFiles(); let i = index" 
                      class="list-group-item d-flex justify-content-between align-items-center px-0"
                    >
                      <div class="d-flex align-items-center">
                        <i class="bi me-2 text-primary" [class]="getFileIcon(file.type)"></i>
                        <div>
                          <div class="fw-semibold">{{ file.name }}</div>
                          <small class="text-muted">{{ formatFileSize(file.size) }}</small>
                        </div>
                      </div>
                      <button 
                        type="button" 
                        class="btn btn-outline-danger btn-sm"
                        (click)="removeSelectedFile(i)"
                      >
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Uploaded Attachments (for editing) -->
                <div *ngIf="uploadedAttachments().length > 0" class="mb-3">
                  <h6 class="text-muted">Current Attachments:</h6>
                  <div class="list-group list-group-flush">
                    <div 
                      *ngFor="let attachment of uploadedAttachments(); let i = index" 
                      class="list-group-item d-flex justify-content-between align-items-center px-0"
                    >
                      <div class="d-flex align-items-center">
                        <i class="bi me-2 text-success" [class]="getFileIcon(attachment.type)"></i>
                        <div>
                          <div class="fw-semibold">{{ attachment.originalName }}</div>
                          <small class="text-muted">{{ formatFileSize(attachment.size) }} â€¢ {{ attachment.downloads }} downloads</small>
                        </div>
                      </div>
                      <button 
                        type="button" 
                        class="btn btn-outline-danger btn-sm"
                        (click)="removeUploadedAttachment(i)"
                      >
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- File Size Warning -->
                <div *ngIf="getTotalFileSize() > 50 * 1024 * 1024" class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  Large file size ({{ formatFileSize(getTotalFileSize()) }}). Consider reducing file count or size for better performance.
                </div>
              </div>

              <div class="d-flex gap-2">
                <button
                  type="submit"
                  class="btn btn-danger"
                  [disabled]="isSubmitting() || isUploadingFiles() || !title().trim() || !content().trim()"
                >
                  <span *ngIf="isSubmitting() || isUploadingFiles()" class="spinner-border spinner-border-sm me-2"></span>
                  <span *ngIf="isUploadingFiles()">Uploading Files...</span>
                  <span *ngIf="!isUploadingFiles() && isSubmitting()">Saving...</span>
                  <span *ngIf="!isSubmitting() && !isUploadingFiles()">
                    {{ isEditMode() ? 'Update Announcement' : 'Create New Announcement' }}
                  </span>
                </button>
                
                <button
                  *ngIf="hasAnnouncement() && !isEditMode()"
                  type="button"
                  class="btn btn-outline-primary"
                  (click)="editCurrentAnnouncement()"
                >
                  <i class="bi bi-pencil me-1"></i>
                  Edit Current
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Current Announcement Preview -->
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-header bg-white">
            <h6 class="mb-0">
              <i class="bi bi-eye-fill me-2"></i>
              {{ hasAnnouncement() ? 'Current Announcement' : 'No Announcement' }}
            </h6>
          </div>
          <div class="card-body">
            <div *ngIf="currentAnnouncement() as ann; else noAnnouncement">
              <h6 class="text-primary">{{ ann.title }}</h6>
              <p class="small text-muted mb-2">{{ ann.content }}</p>
              <div class="d-flex justify-content-between text-muted small mb-2">
                <span>
                  <i class="bi bi-heart-fill text-danger"></i> {{ ann.likes }}
                </span>
                <span *ngIf="ann.attachments && ann.attachments.length > 0">
                  <i class="bi bi-paperclip text-info"></i> {{ ann.attachments.length }} file{{ ann.attachments.length !== 1 ? 's' : '' }}
                </span>
              </div>
              <div class="text-end">
                <small class="text-muted">Updated: {{ formatDate(ann.updatedAt) }}</small>
              </div>
            </div>
            <ng-template #noAnnouncement>
              <div class="text-center text-muted py-3">
                <i class="bi bi-megaphone display-4 d-block mb-2"></i>
                <p class="mb-0">No announcement available</p>
                <small>Create your first announcement using the form</small>
              </div>
            </ng-template>
          </div>
        </div>

        <!-- Recent Viewers -->
        <div class="card shadow-sm mt-3">
          <div class="card-header bg-white">
            <h6 class="mb-0">
              <i class="bi bi-clock-history me-2"></i>
              Recent Viewers
            </h6>
          </div>
          <div class="card-body">
            <div *ngIf="viewedUsers().length === 0" class="text-center text-muted py-2">
              <small>No viewers yet</small>
            </div>
            <div *ngIf="viewedUsers().length > 0">
              <div *ngFor="let user of viewedUsers().slice(-5)" class="d-flex align-items-center mb-2">
                <i class="bi bi-person-circle text-primary me-2"></i>
                <div class="flex-grow-1">
                  <small class="d-block">{{ user.name }}</small>
                  <small class="text-muted">{{ formatDate(user.viewedAt) }}</small>
                </div>
                <small *ngIf="user.hasLiked" class="text-danger">
                  <i class="bi bi-heart-fill"></i>
                </small>
              </div>
              <div *ngIf="viewedUsers().length > 5" class="text-center">
                <small class="text-muted">+{{ viewedUsers().length - 5 }} more viewers</small>
              </div>
            </div>
          </div>
        </div>

        <!-- File Analytics -->
        <div *ngIf="getTopDownloadedFiles().length > 0" class="card shadow-sm mt-3">
          <div class="card-header bg-white">
            <h6 class="mb-0">
              <i class="bi bi-bar-chart me-2"></i>
              Top Downloaded Files
            </h6>
          </div>
          <div class="card-body">
            <div *ngFor="let file of getTopDownloadedFiles().slice(0, 5)" class="d-flex align-items-center mb-2">
              <i class="me-2 text-warning" [class]="getFileIcon(file.type)"></i>
              <div class="flex-grow-1">
                <small class="d-block fw-semibold text-truncate" [title]="file.originalName">
                  {{ file.originalName }}
                </small>
                <small class="text-muted">{{ formatFileSize(file.size) }}</small>
              </div>
              <div class="text-end">
                <small class="text-warning fw-bold">{{ file.downloads }}</small>
                <small class="d-block text-muted">downloads</small>
              </div>
            </div>
            <div *ngIf="getTopDownloadedFiles().length > 5" class="text-center">
              <small class="text-muted">+{{ getTopDownloadedFiles().length - 5 }} more files</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hierarchical Admin Section -->
    <div *ngIf="hasSubordinates()" class="row mt-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-gradient bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-diagram-3 me-2"></i>
              Department Hierarchy & Subordinate Announcements
            </h5>
            <button 
              class="btn btn-outline-light btn-sm"
              (click)="toggleHierarchy()"
            >
              <i class="bi" [class.bi-chevron-down]="!showHierarchy()" [class.bi-chevron-up]="showHierarchy()"></i>
              {{ showHierarchy() ? 'Hide' : 'Show' }} Hierarchy
            </button>
          </div>
          
          <div *ngIf="showHierarchy()" class="card-body p-0">
            <div class="row g-0">
              <!-- Hierarchy Tree -->
              <div class="col-lg-5 border-end">
                <div class="p-3">
                  <h6 class="text-primary mb-3">
                    <i class="bi bi-people me-1"></i>
                    Officer Hierarchy
                  </h6>
                  <app-role-hierarchy 
                    [currentUser]="currentAdmin()!" 
                    (selectOfficer)="onSelectOfficer($event)">
                  </app-role-hierarchy>
                </div>
              </div>
              
              <!-- Selected Officer's Announcements -->
              <div class="col-lg-7">
                <div class="p-3">
                  <div *ngIf="selectedOfficer(); else noOfficerSelected">
                    <div class="d-flex align-items-center mb-3">
                      <div class="me-3">
                        <i class="display-6 text-info bi-person-badge"></i>
                      </div>
                      <div>
                        <h6 class="mb-1">{{ selectedOfficer()!.fullName }}</h6>
                        <p class="text-muted mb-1 small">{{ selectedOfficer()!.role.displayName }}</p>
                        <span class="badge bg-info">{{ selectedOfficer()!.department }}</span>
                      </div>
                    </div>
                    
                    <h6 class="text-success mb-3">
                      <i class="bi bi-megaphone me-1"></i>
                      Announcements ({{ selectedOfficerAnnouncements().length }})
                    </h6>
                    
                    <div *ngIf="selectedOfficerAnnouncements().length > 0; else noAnnouncements" class="announcements-list">
                      <div *ngFor="let announcement of selectedOfficerAnnouncements()" 
                           class="card mb-3 border-start border-info border-3">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-1">{{ announcement.title }}</h6>
                            <span class="badge" [class]="getAnnouncementPriorityBadge(announcement.priority)">
                              {{ announcement.priority || 'medium' }}
                            </span>
                          </div>
                          
                          <p class="card-text small text-muted mb-2">{{ announcement.content }}</p>
                          
                          <div class="d-flex justify-content-between align-items-center">
                            <div class="small text-muted">
                              <i class="bi bi-calendar3 me-1"></i>
                              {{ formatDate(announcement.createdAt) }}
                              <span *ngIf="announcement.attachments && announcement.attachments.length > 0" class="ms-2">
                                <i class="bi bi-paperclip text-info"></i>
                                {{ announcement.attachments.length }} file{{ announcement.attachments.length !== 1 ? 's' : '' }}
                              </span>
                            </div>
                            
                            <div class="btn-group btn-group-sm">
                              <button 
                                *ngIf="canEditSelectedAnnouncement(announcement)"
                                class="btn btn-outline-primary btn-sm"
                                (click)="editAnnouncement(announcement.id)"
                                title="Edit Announcement"
                              >
                                <i class="bi bi-pencil"></i>
                              </button>
                              <button 
                                *ngIf="canDeleteSelectedAnnouncement(announcement)"
                                class="btn btn-outline-danger btn-sm"
                                (click)="deleteSpecificAnnouncement(announcement.id)"
                                title="Delete Announcement"
                              >
                                <i class="bi bi-trash3"></i>
                              </button>
                            </div>
                          </div>
                          
                          <!-- File Attachments -->
                          <div *ngIf="announcement.attachments && announcement.attachments.length > 0" class="mt-2">
                            <div class="row g-2">
                              <div *ngFor="let file of announcement.attachments" class="col-md-6">
                                <div class="card card-body p-2 bg-light">
                                  <div class="d-flex align-items-center">
                                    <i class="me-2" [class]="getFileIcon(file.type)"></i>
                                    <div class="flex-grow-1 text-truncate">
                                      <small class="fw-semibold">{{ file.originalName }}</small>
                                      <small class="d-block text-muted">{{ formatFileSize(file.size) }}</small>
                                    </div>
                                    <small class="text-warning">{{ file.downloads }} downloads</small>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <ng-template #noAnnouncements>
                      <div class="text-center py-4">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="text-muted mt-2">No announcements from this officer</p>
                      </div>
                    </ng-template>
                  </div>
                  
                  <ng-template #noOfficerSelected>
                    <div class="text-center py-5">
                      <i class="bi bi-person-plus display-1 text-muted"></i>
                      <p class="text-muted mt-3">Select an officer from the hierarchy to view their announcements</p>
                      <p class="small text-muted">You can view announcements from officers with lower seniority levels</p>
                    </div>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div 
  *ngIf="showDeleteConfirm()" 
  class="modal fade show d-block" 
  style="background-color: rgba(0,0,0,0.5);"
  (click)="hideDeleteConfirmation()"
>
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          Confirm Delete
        </h5>
        <button type="button" class="btn-close" (click)="hideDeleteConfirmation()"></button>
      </div>
      <div class="modal-body">
        <p><strong>Are you sure you want to delete this announcement?</strong></p>
        <p class="text-muted mb-0">This action cannot be undone. All likes and engagement data will be lost.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="hideDeleteConfirmation()">
          Cancel
        </button>
        <button 
          type="button" 
          class="btn btn-danger"
          (click)="confirmDelete()"
          [disabled]="isDeleting()"
        >
          <span *ngIf="isDeleting()" class="spinner-border spinner-border-sm me-2"></span>
          {{ isDeleting() ? 'Deleting...' : 'Delete Announcement' }}
        </button>
      </div>
    </div>
  </div>
</div>
